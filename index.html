<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LE PALACE - Comptabilit√© v2.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 1200px;
            overflow: hidden;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .login-section {
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        input, select, textarea {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .main-app {
            display: none;
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .main-app.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }

        th {
            background: #f0f0f0;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .success {
            color: #10b981;
            font-weight: 600;
        }

        .error {
            color: #ef4444;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f0f0f0;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .user-info span {
            font-weight: 600;
            color: #333;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h4 {
            opacity: 0.9;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .stat-card p {
            font-size: 2em;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .action-buttons button {
            padding: 10px 20px;
            font-size: 0.9em;
        }

        .message {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.admin {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge.gerant {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.employe {
            background: #dbeafe;
            color: #1e40af;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .product-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        .product-checkbox input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .text-danger {
            color: #ef4444;
        }

        .collaborative-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .collab-card {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collab-card.inactive {
            opacity: 0.5;
            background: #f9f9f9;
        }

        .collab-info {
            flex: 1;
        }

        .collab-actions {
            display: flex;
            gap: 5px;
        }

        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .grid-2col {
                grid-template-columns: 1fr;
            }
            .table-container {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- LOGIN SECTION -->
        <div id="loginSection" class="active">
            <div class="header">
                <h1>üëë LE PALACE</h1>
                <p>Syst√®me de Comptabilit√© pour Bars & Restaurants v2.1</p>
            </div>

            <div class="login-section">
                <div class="form-group">
                    <label for="username">Pseudo</label>
                    <input type="text" id="username" placeholder="Entrez votre pseudo">
                </div>

                <div class="form-group">
                    <label for="pin">PIN (4 chiffres)</label>
                    <input type="password" id="pin" placeholder="Entrez votre PIN" maxlength="4" inputmode="numeric">
                </div>

                <button class="btn-primary" onclick="login()">Connexion</button>

                <div id="loginError" style="display: none; color: #ef4444; text-align: center; padding: 10px; background: #fee2e2; border-radius: 6px;"></div>
            </div>
        </div>

        <!-- MAIN APP SECTION -->
        <div id="mainApp" class="main-app">
            <div class="header" style="padding: 20px; margin: -30px -30px 20px -30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h1 style="font-size: 2em;">üëë LE PALACE</h1>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <span id="userDisplay" style="color: white;"></span>
                        <button class="logout-btn" onclick="logout()">D√©connexion</button>
                    </div>
                </div>
            </div>

            <!-- USER INFO -->
            <div class="user-info">
                <div>
                    <span>Utilisateur: </span>
                    <span id="userName" style="color: #667eea;"></span>
                </div>
                <div>
                    <span id="userRole" class="badge"></span>
                </div>
            </div>

            <!-- STATS -->
            <div class="stats">
                <div class="stat-card">
                    <h4>üí∞ Total Ventes (Aujourd'hui)</h4>
                    <p id="totalSalesToday">0.00 ‚Ç¨</p>
                </div>
                <div class="stat-card">
                    <h4>üë• Collaborateurs</h4>
                    <p id="totalCollaborators">0</p>
                </div>
                <div class="stat-card">
                    <h4>üìä Commission (30%)</h4>
                    <p id="totalCommission">0.00 ‚Ç¨</p>
                </div>
                <div class="stat-card" id="cashBalanceCard">
                    <h4>üíµ Solde Caisse</h4>
                    <p id="cashBalance">0.00 ‚Ç¨</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <h4>üßæ Liquide en Attente (Frigo)</h4>
                    <p id="liquidPending">0.00 ‚Ç¨</p>
                </div>
            </div>

            <!-- TABS -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('sales')">üìä Ventes</button>
                <button class="tab-button" id="movementsTab" onclick="switchTab('movements')" style="display: none;">üí∏ Mouvements</button>
                <button class="tab-button" onclick="switchTab('expenses')">üìã Notes de Frais</button>
                <button class="tab-button" onclick="switchTab('collaborators')">üë• Collaborateurs</button>
                <button class="tab-button" id="productsTab" onclick="switchTab('products')" style="display: none;">üç∑ Produits</button>
                <button class="tab-button" onclick="switchTab('settings')">‚öôÔ∏è Param√®tres</button>
            </div>

            <!-- TAB 1: SALES -->
            <div id="sales" class="tab-content active">
                <div class="form-section">
                    <h3>Enregistrer une Vente</h3>
                    <div class="form-row">
                        <div class="form-group" id="collaboratorSelectGroup" style="display: none;">
                            <label for="collaboratorSelect">Collaborateur</label>
                            <select id="collaboratorSelect">
                                <option value="">-- S√©lectionner --</option>
                            </select>
                        </div>
                        <div class="form-group" id="currentCollaboratorGroup" style="display: none;">
                            <label>Collaborateur</label>
                            <input type="text" id="currentCollaboratorDisplay" disabled style="background: #f0f0f0;">
                        </div>
                        <div class="form-group">
                            <label for="paymentMode">Mode de Paiement</label>
                            <select id="paymentMode">
                                <option value="liquide">Liquide</option>
                                <option value="virement">Virement</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üì¶ S√©lectionner les Produits</label>
                        <div id="productsCheckboxList" style="max-height: 250px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 10px; border-radius: 6px; background: white;">
                            <!-- Produits seront charg√©s ici -->
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label><input type="checkbox" id="isVipLounge"> ü•Ç Location Carr√© VIP (500‚Ç¨)</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="saleNotes">Notes / Motif</label>
                        <textarea id="saleNotes" placeholder="Pr√©cisions sur la commande..." rows="2"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="grid-column: auto;">
                            <label>Montant Total</label>
                            <input type="text" id="totalAmount" disabled style="background: #f0f0f0; font-weight: bold;">
                        </div>
                    </div>

                    <button class="btn-primary" onclick="recordSale()">‚úì Enregistrer la Vente</button>
                    <div id="saleMessage"></div>
                </div>

                <div class="table-container">
                    <h3>Historique des Ventes</h3>
                    <table id="salesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Collaborateur</th>
                                <th>Montant</th>
                                <th>Mode</th>
                                <th>Produits</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="salesBody">
                            <tr><td colspan="7" class="loading">Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 2: MOVEMENTS -->
            <div id="movements" class="tab-content">
                <div class="form-section">
                    <h3>Ajouter un Mouvement de Caisse</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="movementType">Type de Mouvement</label>
                            <select id="movementType">
                                <option value="depot">D√©p√¥t</option>
                                <option value="retrait">Retrait</option>
                                <option value="depense">D√©pense</option>
                                <option value="commission">Commission Pay√©e</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="movementAmount">Montant (‚Ç¨)</label>
                            <input type="number" id="movementAmount" placeholder="0.00" step="0.01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="movementDescription">Description</label>
                        <textarea id="movementDescription" placeholder="D√©tails du mouvement..." rows="3"></textarea>
                    </div>
                    <button class="btn-primary" onclick="recordMovement()">‚úì Enregistrer</button>
                    <div id="movementMessage"></div>
                </div>

                <div class="table-container">
                    <h3>Historique des Mouvements</h3>
                    <table id="movementsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Montant</th>
                                <th>Solde Apr√®s</th>
                            </tr>
                        </thead>
                        <tbody id="movementsBody">
                            <tr><td colspan="5" class="loading">Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 3: EXPENSES -->
            <div id="expenses" class="tab-content">
                <div class="form-section">
                    <h3>Demander un Remboursement</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseType">Type de D√©pense</label>
                            <select id="expenseType">
                                <option value="">-- S√©lectionner --</option>
                                <option value="transport">Transport</option>
                                <option value="fournitures">Fournitures</option>
                                <option value="repas">Repas</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expenseAmount">Montant (‚Ç¨)</label>
                            <input type="number" id="expenseAmount" placeholder="0.00" step="0.01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="expenseDescription">Description / Justification</label>
                        <textarea id="expenseDescription" placeholder="D√©tails de la d√©pense..." rows="3"></textarea>
                    </div>
                    <button class="btn-primary" onclick="submitExpense()">‚úì Soumettre la Demande</button>
                    <div id="expenseMessage"></div>
                </div>

                <div class="table-container" id="adminExpensesPanel" style="display: none;">
                    <h3>Notes de Frais en Attente (Admin/G√©rant)</h3>
                    <table id="expensesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Demandeur</th>
                                <th>Type</th>
                                <th>Montant</th>
                                <th>Description</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesBody">
                            <tr><td colspan="7" class="loading">Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 4: COLLABORATORS -->
            <div id="collaborators" class="tab-content">
                <div class="form-section" id="addCollaboratorSection" style="display: none;">
                    <h3>Ajouter un Collaborateur</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newCollaboratorName">Nom</label>
                            <input type="text" id="newCollaboratorName" placeholder="Jean Dupont">
                        </div>
                        <div class="form-group">
                            <label for="newCollaboratorRole">R√¥le</label>
                            <select id="newCollaboratorRole">
                                <option value="employe">Employ√©</option>
                                <option value="gerant">G√©rant</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newCollaboratorPin">PIN</label>
                            <input type="text" id="newCollaboratorPin" placeholder="1234" maxlength="4" inputmode="numeric">
                        </div>
                    </div>
                    <button class="btn-primary" onclick="addCollaborator()">‚úì Ajouter</button>
                    <div id="collaboratorMessage"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn-primary" id="addCollaboratorBtn" onclick="toggleAddCollaborator()" style="display: none;">+ Ajouter Collaborateur</button>
                    <button class="btn-secondary" onclick="changeMyPassword()">üîê Changer Mon PIN</button>
                </div>

                <div class="table-container">
                    <h3>Collaborateurs</h3>
                    <div id="collaboratorsGrid" class="collaborative-list"></div>
                </div>
            </div>

            <!-- TAB 5: PRODUCTS -->
            <div id="products" class="tab-content">
                <div class="form-section" id="addProductSection" style="display: none;">
                    <h3>Ajouter un Produit</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newProductName">Nom du Produit</label>
                            <input type="text" id="newProductName" placeholder="Ex: Bi√®re Blonde">
                        </div>
                        <div class="form-group">
                            <label for="newProductCategory">Cat√©gorie</label>
                            <input type="text" id="newProductCategory" placeholder="Ex: Boissons">
                        </div>
                        <div class="form-group">
                            <label for="newProductPrice">Prix (‚Ç¨)</label>
                            <input type="number" id="newProductPrice" placeholder="0.00" step="0.01">
                        </div>
                    </div>
                    <button class="btn-primary" onclick="addProduct()">‚úì Ajouter</button>
                    <div id="productMessage"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn-primary" id="addProductBtn" onclick="toggleAddProduct()" style="display: none;">+ Ajouter Produit</button>
                </div>

                <div class="table-container">
                    <h3>Catalogue des Produits</h3>
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Cat√©gorie</th>
                                <th>Prix</th>
                                <th>√âtat</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsBody">
                            <tr><td colspan="5" class="loading">Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 6: SETTINGS -->
            <div id="settings" class="tab-content">
                <div class="form-section" id="settingsSection" style="display: none;">
                    <h3>Param√®tres G√©n√©raux</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="commissionRate">Taux de Commission (%)</label>
                            <input type="number" id="commissionRate" placeholder="30" step="0.01">
                        </div>
                    </div>
                    <button class="btn-primary" onclick="updateSettings()">‚úì Mettre √† Jour</button>
                    <div id="settingsMessage"></div>
                </div>

                <div class="form-section" id="correctCashSection" style="display: none;">
                    <h3>‚ö†Ô∏è Corriger le Solde de Caisse (Admin Seulement)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Solde Actuel</label>
                            <input type="text" id="currentCashDisplay" disabled style="background: #f0f0f0; font-weight: bold;">
                        </div>
                        <div class="form-group">
                            <label for="newCashBalance">Nouveau Solde (‚Ç¨)</label>
                            <input type="number" id="newCashBalance" placeholder="0.00" step="0.01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cashCorrectionReason">Motif de la Correction</label>
                        <textarea id="cashCorrectionReason" placeholder="Raison de la modification..." rows="2"></textarea>
                    </div>
                    <button class="btn-primary" onclick="correctCashBalance()">‚úì Appliquer la Correction</button>
                    <div id="cashCorrectionMessage"></div>
                </div>

                <div class="action-buttons" style="display: none;" id="adminPanel">
                    <button class="btn-secondary" onclick="exportData()">üì• Exporter les Donn√©es</button>
                    <button class="btn-secondary" onclick="clearAllData()" style="background: #fee2e2; color: #991b1b;">üóëÔ∏è R√©initialiser (Attention!)</button>
                </div>

                <div style="background: #f0f0f0; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h3>√Ä Propos</h3>
                    <p>LE PALACE v2.1 - Comptabilit√© Cloud</p>
                    <p style="margin-top: 10px; color: #666; font-size: 0.95em;">Gestion des ventes, produits, collaborateurs, notes de frais et mouvements de caisse</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="editSaleModal" class="modal">
        <div class="modal-content">
            <h3>Modifier la Vente</h3>
            <div class="form-group">
                <label for="editSaleAmount">Montant (‚Ç¨)</label>
                <input type="number" id="editSaleAmount" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label for="editSaleNotes">Notes</label>
                <textarea id="editSaleNotes" rows="3"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('editSaleModal')">Annuler</button>
                <button class="btn-primary" onclick="saveSaleEdit()">Enregistrer</button>
            </div>
        </div>
    </div>

    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <h3>Changer le PIN</h3>
            <div class="form-group">
                <label for="currentPin">PIN actuel</label>
                <input type="password" id="currentPin" placeholder="****" maxlength="4" inputmode="numeric">
            </div>
            <div class="form-group">
                <label for="newPin">Nouveau PIN</label>
                <input type="password" id="newPin" placeholder="****" maxlength="4" inputmode="numeric">
            </div>
            <div class="form-group">
                <label for="confirmPin">Confirmer le PIN</label>
                <input type="password" id="confirmPin" placeholder="****" maxlength="4" inputmode="numeric">
            </div>
            <div id="passwordMessage"></div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('changePasswordModal')">Annuler</button>
                <button class="btn-primary" onclick="saveNewPassword()">Mettre √† jour</button>
            </div>
        </div>
    </div>

    <div id="changeUserRoleModal" class="modal">
        <div class="modal-content">
            <h3>Modifier le R√¥le</h3>
            <p id="changeRoleUserName"></p>
            <div class="form-group">
                <label for="changeRoleSelect">Nouveau R√¥le</label>
                <select id="changeRoleSelect">
                    <option value="employe">Employ√©</option>
                    <option value="gerant">G√©rant</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('changeUserRoleModal')">Annuler</button>
                <button class="btn-primary" onclick="saveUserRole()">Appliquer</button>
            </div>
        </div>
    </div>

    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <h3>Modifier le Produit</h3>
            <div class="form-group">
                <label for="editProductName">Nom du Produit</label>
                <input type="text" id="editProductName">
            </div>
            <div class="form-group">
                <label for="editProductCategory">Cat√©gorie</label>
                <input type="text" id="editProductCategory">
            </div>
            <div class="form-group">
                <label for="editProductPrice">Prix (‚Ç¨)</label>
                <input type="number" id="editProductPrice" step="0.01">
            </div>
            <div id="editProductMessage"></div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('editProductModal')">Annuler</button>
                <button class="btn-primary" onclick="saveProductEdit()">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://wjhbnyrjyjaezaktueny.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqaGJueXJqeWphZXpha3R1ZW55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNTI4NjQsImV4cCI6MjA4NDkyODg2NH0.c0MAaZdNyj_l0ccso78YO2Ca39Me-MSbvauo5Hjkxuc';

        let supabaseClient = null;

        function initSupabase() {
            if (window.supabase && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                if (SUPABASE_URL.includes('YOUR_PROJECT')) {
                    alert('‚ùå Erreur: Configurez d\'abord vos cl√©s Supabase!\n\nRemplissez SUPABASE_URL et SUPABASE_ANON_KEY dans le code.');
                }
            } else {
                alert('‚ùå Erreur: La librairie Supabase n\'a pas pu √™tre charg√©e!');
            }
        }

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let currentUser = null;
        let currentTab = 'sales';
        let salesData = [];
        let movementsData = [];
        let collaboratorsData = [];
        let productsData = [];
        let expensesData = [];
        let settingsData = null;
        let selectedProducts = {};
        let editingSaleId = null;
        let editingProductId = null;

        // ============================================
        // LOGIN / LOGOUT
        // ============================================
        async function login() {
            const username = document.getElementById('username').value.trim();
            const pin = document.getElementById('pin').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!username || !pin) {
                errorDiv.textContent = 'Veuillez remplir tous les champs';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('collaborators')
                    .select('*')
                    .eq('name', username)
                    .eq('pin_code', pin)
                    .eq('is_active', true)
                    .single();

                if (error || !data) {
                    errorDiv.textContent = 'Identifiants incorrects ou compte d√©sactiv√©';
                    errorDiv.style.display = 'block';
                    return;
                }

                currentUser = data;
                errorDiv.style.display = 'none';

                document.getElementById('loginSection').classList.remove('active');
                document.getElementById('mainApp').classList.add('active');

                updateUserDisplay();
                loadAllData();
                setupRealtimeSubscriptions();
            } catch (err) {
                errorDiv.textContent = 'Erreur: ' + err.message;
                errorDiv.style.display = 'block';
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('loginSection').classList.add('active');
            document.getElementById('username').value = '';
            document.getElementById('pin').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // ============================================
        // UI UPDATES
        // ============================================
        function updateUserDisplay() {
            const roleMap = {
                'admin': 'Admin üëë',
                'gerant': 'G√©rant üìã',
                'employe': 'Employ√© üíº'
            };

            document.getElementById('userName').textContent = currentUser.name;
            const userRole = document.getElementById('userRole');
            userRole.textContent = roleMap[currentUser.role] || currentUser.role;
            userRole.className = `badge ${currentUser.role}`;

            document.getElementById('userDisplay').textContent = currentUser.name + ' (' + roleMap[currentUser.role] + ')';

            // Affichage du select collaborateur selon le r√¥le
            if (currentUser.role === 'employe') {
                document.getElementById('collaboratorSelectGroup').style.display = 'none';
                document.getElementById('currentCollaboratorGroup').style.display = 'block';
                document.getElementById('currentCollaboratorDisplay').value = currentUser.name;
            } else {
                document.getElementById('collaboratorSelectGroup').style.display = 'block';
                document.getElementById('currentCollaboratorGroup').style.display = 'none';
            }

            // Affichage solde caisse selon le r√¥le
            if (currentUser.role === 'employe') {
                document.getElementById('cashBalanceCard').style.display = 'none';
            } else {
                document.getElementById('cashBalanceCard').style.display = 'block';
            }

            // Show admin/gerant features
            if (currentUser.role === 'admin' || currentUser.role === 'gerant') {
                document.getElementById('addCollaboratorBtn').style.display = 'block';
                document.getElementById('settingsSection').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'flex';
                document.getElementById('addProductBtn').style.display = 'block';
                document.getElementById('productsTab').style.display = 'block';
                document.getElementById('movementsTab').style.display = 'block';
                document.getElementById('adminExpensesPanel').style.display = 'block';
            }

            if (currentUser.role === 'admin') {
                document.getElementById('correctCashSection').style.display = 'block';
            }
        }

        function switchTab(tabName) {
            currentTab = tabName;

            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');

            if (event && event.target) {
                event.target.classList.add('active');
            }

            if (tabName === 'products') {
                loadProducts();
            }
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (!element) return;

            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';

            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadAllData() {
            await Promise.all([
                loadCollaborators(),
                loadProducts(),
                loadSales(),
                loadMovements(),
                loadExpenses(),
                loadSettings()
            ]);
        }

        async function loadCollaborators() {
            const { data, error } = await supabaseClient
                .from('collaborators')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading collaborators:', error);
                return;
            }

            collaboratorsData = data || [];

            const select = document.getElementById('collaboratorSelect');
            select.innerHTML = '<option value="">-- S√©lectionner --</option>';
            collaboratorsData.filter(c => c.is_active).forEach(collab => {
                const option = document.createElement('option');
                option.value = collab.id;
                option.textContent = collab.name;
                select.appendChild(option);
            });

            renderCollaboratorsGrid();
            document.getElementById('totalCollaborators').textContent = collaboratorsData.filter(c => c.is_active).length;
        }

        function renderCollaboratorsGrid() {
            const grid = document.getElementById('collaboratorsGrid');
            const roleMap = { 'admin': 'Admin üëë', 'gerant': 'G√©rant üìã', 'employe': 'Employ√© üíº' };

            grid.innerHTML = collaboratorsData.map(collab => `
                <div class="collab-card ${!collab.is_active ? 'inactive' : ''}">
                    <div class="collab-info">
                        <strong>${collab.name}</strong><br>
                        <span class="badge ${collab.role}">${roleMap[collab.role]}</span>
                        ${!collab.is_active ? '<br><span class="text-danger">D√©sactiv√©</span>' : ''}
                    </div>
                    <div class="collab-actions">
                        ${currentUser.role === 'admin' ? `
                            <button class="btn-secondary btn-small" onclick="openChangeRoleModal(${collab.id}, '${collab.name}', '${collab.role}')">R√¥le</button>
                            <button class="btn-danger btn-small" onclick="deleteCollaborator(${collab.id}, '${collab.name}')">${collab.is_active ? 'Supprimer' : 'Restaurer'}</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function loadProducts() {
            const { data, error } = await supabaseClient
                .from('products')
                .select('*')
                .eq('active', true)
                .order('category', { ascending: true });

            if (error) {
                console.error('Error loading products:', error);
                return;
            }

            productsData = data || [];
            renderProductsCheckboxes();
            renderProductsTable();
        }

        function renderProductsCheckboxes() {
            const container = document.getElementById('productsCheckboxList');
            if (!container) return;

            const grouped = {};
            productsData.forEach(p => {
                if (!grouped[p.category]) grouped[p.category] = [];
                grouped[p.category].push(p);
            });

            container.innerHTML = Object.keys(grouped).map(category => `
                <div style="margin-bottom: 15px;">
                    <strong style="display: block; margin-bottom: 8px; color: #667eea;">${category}</strong>
                    ${grouped[category].map(product => `
                        <div class="product-checkbox">
                            <input type="checkbox" id="product_${product.id}" value="${product.id}" data-price="${product.price}" data-name="${product.name}" onchange="updateTotalAmount()">
                            <label for="product_${product.id}" style="margin: 0; cursor: pointer;">${product.name} - ${product.price.toFixed(2)}‚Ç¨</label>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        function renderProductsTable() {
            const tbody = document.getElementById('productsBody');
            if (!tbody) return;

            if (productsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">Aucun produit</td></tr>';
            } else {
                tbody.innerHTML = productsData.map(product => `
                    <tr>
                        <td><strong>${product.name}</strong></td>
                        <td>${product.category}</td>
                        <td class="success">${product.price.toFixed(2)}‚Ç¨</td>
                        <td>${product.active ? '‚úì Actif' : '‚úó Inactif'}</td>
                        <td>
                            ${currentUser.role === 'admin' || currentUser.role === 'gerant' ? `
                                <button class="btn-secondary btn-small" onclick="openEditProductModal(${product.id}, '${product.name.replace(/'/g, "\\'")}', '${product.category.replace(/'/g, "\\'")}', ${product.price})">Modifier</button>
                                <button class="btn-danger btn-small" onclick="deleteProduct(${product.id})">Supprimer</button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('');
            }
        }

        function updateTotalAmount() {
            let total = 0;
            document.querySelectorAll('#productsCheckboxList input[type="checkbox"]:checked').forEach(input => {
                total += parseFloat(input.dataset.price);
            });

            if (document.getElementById('isVipLounge').checked) {
                total += 500;
            }

            document.getElementById('totalAmount').value = total.toFixed(2) + ' ‚Ç¨';
        }

        async function loadSales() {
            const { data, error } = await supabaseClient
                .from('sales')
                .select('*')
                .eq('is_active', true)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading sales:', error);
                return;
            }

            salesData = data || [];

            const tbody = document.getElementById('salesBody');
            if (salesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Aucune vente enregistr√©e</td></tr>';
            } else {
                tbody.innerHTML = salesData.map(sale => `
                    <tr>
                        <td>${new Date(sale.created_at).toLocaleString('fr-FR')}</td>
                        <td>${sale.collaborator_name}</td>
                        <td class="success">${sale.amount.toFixed(2)}‚Ç¨</td>
                        <td>${sale.payment_mode}</td>
                        <td>${sale.product_name || '-'}</td>
                        <td>${sale.notes || '-'}</td>
                        <td>
                            <button class="btn-secondary btn-small" onclick="editSale(${sale.id}, ${sale.amount}, '${(sale.notes || '').replace(/'/g, "\\'")}')">Modifier</button>
                            ${currentUser.role === 'admin' ? `<button class="btn-danger btn-small" onclick="deleteSale(${sale.id})">Supprimer</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            }

            updateStats();
        }

        async function loadMovements() {
            const { data, error } = await supabaseClient
                .from('movements')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading movements:', error);
                return;
            }

            movementsData = data || [];

            const tbody = document.getElementById('movementsBody');
            if (movementsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">Aucun mouvement</td></tr>';
            } else {
                tbody.innerHTML = movementsData.map(mov => `
                    <tr>
                        <td>${new Date(mov.created_at).toLocaleString('fr-FR')}</td>
                        <td><strong>${mov.type}</strong></td>
                        <td>${mov.description || '-'}</td>
                        <td class="success">${mov.amount.toFixed(2)}‚Ç¨</td>
                        <td class="success">${mov.balance_after.toFixed(2)}‚Ç¨</td>
                    </tr>
                `).join('');
            }

            updateStats();
        }

        async function loadExpenses() {
            const { data, error } = await supabaseClient
                .from('expense_requests')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading expenses:', error);
                return;
            }

            expensesData = data || [];

            const tbody = document.getElementById('expensesBody');
            if (expensesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Aucune demande de remboursement</td></tr>';
            } else {
                tbody.innerHTML = expensesData.map(expense => `
                    <tr style="opacity: ${expense.status === 'approved' ? '0.6' : '1'};">
                        <td>${new Date(expense.created_at).toLocaleString('fr-FR')}</td>
                        <td>${expense.employee_name}</td>
                        <td>${expense.expense_type}</td>
                        <td class="success">${expense.amount.toFixed(2)}‚Ç¨</td>
                        <td>${expense.description || '-'}</td>
                        <td>
                            <span class="badge ${expense.status === 'pending' ? '' : 'admin'}" 
                                  style="background: ${expense.status === 'pending' ? '#fef3c7' : '#d1fae5'}; color: ${expense.status === 'pending' ? '#92400e' : '#065f46'};">
                                ${expense.status === 'pending' ? 'En Attente' : 'Approuv√©'}
                            </span>
                        </td>
                        <td>
                            ${expense.status === 'pending' ? `
                                <button class="btn-primary btn-small" onclick="approveExpense(${expense.id}, ${expense.amount})">Rembourser</button>
                                <button class="btn-danger btn-small" onclick="rejectExpense(${expense.id})">Refuser</button>
                            ` : 'Valid√©'}
                        </td>
                    </tr>
                `).join('');
            }
        }

        async function loadSettings() {
            const { data, error } = await supabaseClient
                .from('settings')
                .select('*')
                .single();

            if (error) {
                console.error('Error loading settings:', error);
                return;
            }

            settingsData = data;
            document.getElementById('commissionRate').value = settingsData?.commission_rate || 30;
        }

        // ============================================
        // STATISTICS
        // ============================================
        function updateStats() {
            const today = new Date().toDateString();
            const todaySales = salesData.filter(sale => {
                const saleDate = new Date(sale.created_at).toDateString();
                return saleDate === today;
            });
            const totalToday = todaySales.reduce((sum, sale) => sum + parseFloat(sale.amount), 0);
            document.getElementById('totalSalesToday').textContent = totalToday.toFixed(2) + ' ‚Ç¨';

            const commissionRate = settingsData?.commission_rate || 30;
            const totalCommission = (totalToday * commissionRate) / 100;
            document.getElementById('totalCommission').textContent = totalCommission.toFixed(2) + ' ‚Ç¨';

            let cashBalance = 0;
            if (movementsData.length > 0) {
                cashBalance = parseFloat(movementsData[0].balance_after) || 0;
            }
            document.getElementById('cashBalance').textContent = cashBalance.toFixed(2) + ' ‚Ç¨';
            document.getElementById('currentCashDisplay').value = cashBalance.toFixed(2) + ' ‚Ç¨';

            // Calculer le liquide en attente (paiements en liquide non d√©pos√©s)
            const liquidSales = salesData.filter(sale => sale.payment_mode === 'liquide' && sale.is_active);
            const liquidPending = liquidSales.reduce((sum, sale) => sum + parseFloat(sale.amount), 0);
            document.getElementById('liquidPending').textContent = liquidPending.toFixed(2) + ' ‚Ç¨';
        }

        // ============================================
        // RECORD OPERATIONS
        // ============================================
        async function recordSale() {
            let collaboratorId;
            
            if (currentUser.role === 'employe') {
                collaboratorId = currentUser.id;
            } else {
                collaboratorId = document.getElementById('collaboratorSelect').value;
                if (!collaboratorId) {
                    showMessage('saleMessage', 'S√©lectionnez un collaborateur', 'error');
                    return;
                }
            }

            const paymentMode = document.getElementById('paymentMode').value;
            const notes = document.getElementById('saleNotes').value;
            const isVip = document.getElementById('isVipLounge').checked;

            const selectedChecks = Array.from(document.querySelectorAll('#productsCheckboxList input[type="checkbox"]:checked'));
            if (selectedChecks.length === 0 && !isVip) {
                showMessage('saleMessage', 'S√©lectionnez au moins un produit ou le carr√© VIP', 'error');
                return;
            }

            try {
                const collaborator = collaboratorsData.find(c => c.id == collaboratorId);
                let totalAmount = 0;
                let productName = '';

                selectedChecks.forEach(check => {
                    totalAmount += parseFloat(check.dataset.price);
                    productName += check.dataset.name + ', ';
                });

                if (isVip) {
                    totalAmount += 500;
                    productName += 'Carr√© VIP';
                }

                productName = productName.replace(/, $/, '');

                const { error } = await supabaseClient
                    .from('sales')
                    .insert([{
                        collaborator_id: collaboratorId,
                        collaborator_name: collaborator.name,
                        amount: totalAmount,
                        payment_mode: paymentMode,
                        product_name: productName,
                        notes: notes,
                        is_vip_lounge: isVip,
                        is_active: true,
                        updated_by: currentUser.name
                    }]);

                if (error) throw error;

                showMessage('saleMessage', '‚úì Vente enregistr√©e!', 'success');
                document.getElementById('collaboratorSelect').value = '';
                document.getElementById('saleNotes').value = '';
                document.getElementById('isVipLounge').checked = false;
                document.querySelectorAll('#productsCheckboxList input[type="checkbox"]').forEach(c => c.checked = false);
                document.getElementById('totalAmount').value = '0.00 ‚Ç¨';
                loadSales();
            } catch (err) {
                showMessage('saleMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        function editSale(saleId, amount, notes) {
            editingSaleId = saleId;
            document.getElementById('editSaleAmount').value = amount;
            document.getElementById('editSaleNotes').value = notes;
            document.getElementById('editSaleModal').classList.add('active');
        }

        async function saveSaleEdit() {
            if (!editingSaleId) return;

            const newAmount = parseFloat(document.getElementById('editSaleAmount').value);
            const newNotes = document.getElementById('editSaleNotes').value;

            if (!newAmount || newAmount <= 0) {
                showMessage('saleMessage', 'Montant invalide', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('sales')
                    .update({
                        amount: newAmount,
                        notes: newNotes,
                        updated_by: currentUser.name,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', editingSaleId);

                if (error) throw error;

                showMessage('saleMessage', '‚úì Vente modifi√©e!', 'success');
                closeModal('editSaleModal');
                editingSaleId = null;
                loadSales();
            } catch (err) {
                showMessage('saleMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        async function deleteSale(saleId) {
            if (currentUser.role !== 'admin') {
                alert('Seul un admin peut supprimer une vente');
                return;
            }

            if (!confirm('√ätes-vous s√ªr? Cette vente sera marqu√©e comme supprim√©e.')) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('sales')
                    .update({ is_active: false, updated_by: currentUser.name })
                    .eq('id', saleId);

                if (error) throw error;

                showMessage('saleMessage', '‚úì Vente supprim√©e!', 'success');
                loadSales();
            } catch (err) {
                showMessage('saleMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        async function recordMovement() {
            const type = document.getElementById('movementType').value;
            const amount = parseFloat(document.getElementById('movementAmount').value);
            const description = document.getElementById('movementDescription').value;

            if (!amount || amount <= 0) {
                showMessage('movementMessage', 'Montant invalide', 'error');
                return;
            }

            try {
                let currentBalance = 0;
                if (movementsData.length > 0) {
                    currentBalance = parseFloat(movementsData[0].balance_after) || 0;
                }

                let newBalance = currentBalance;
                if (type === 'depot' || type === 'commission') {
                    newBalance += amount;
                } else {
                    newBalance -= amount;
                }

                const { error } = await supabaseClient
                    .from('movements')
                    .insert([{
                        type: type,
                        description: description,
                        amount: amount,
                        balance_after: newBalance
                    }]);

                if (error) throw error;

                showMessage('movementMessage', '‚úì Mouvement enregistr√©!', 'success');
                document.getElementById('movementAmount').value = '';
                document.getElementById('movementDescription').value = '';
                loadMovements();
            } catch (err) {
                showMessage('movementMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        async function addCollaborator() {
            if (currentUser.role !== 'admin' && currentUser.role !== 'gerant') {
                alert('Vous n\'avez pas les droits');
                return;
            }

            const name = document.getElementById('newCollaboratorName').value.trim();
            const role = document.getElementById('newCollaboratorRole').value;
            const pin = document.getElementById('newCollaboratorPin').value.trim();

            if (!name || !pin || pin.length !== 4) {
                showMessage('collaboratorMessage', 'Tous les champs sont requis (PIN: 4 chiffres)', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('collaborators')
                    .insert([{
                        name: name,
                        role: role,
                        pin_code: pin,
                        is_active: true
                    }]);

                if (error) throw error;

                showMessage('collaboratorMessage', '‚úì Collaborateur ajout√©!', 'success');
                document.getElementById('newCollaboratorName').value = '';
                document.getElementById('newCollaboratorPin').value = '';
                toggleAddCollaborator();
                loadCollaborators();
            } catch (err) {
                showMessage('collaboratorMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        function toggleAddCollaborator() {
            const section = document.getElementById('addCollaboratorSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        async function addProduct() {
            if (currentUser.role !== 'admin' && currentUser.role !== 'gerant') {
                alert('Vous n\'avez pas les droits');
                return;
            }

            const name = document.getElementById('newProductName').value.trim();
            const category = document.getElementById('newProductCategory').value.trim();
            const price = parseFloat(document.getElementById('newProductPrice').value);

            if (!name || !category || !price || price <= 0) {
                showMessage('productMessage', 'Tous les champs sont requis', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('products')
                    .insert([{
                        name: name,
                        category: category,
                        price: price,
                        active: true,
                        created_by: currentUser.name
                    }]);

                if (error) throw error;

                showMessage('productMessage', '‚úì Produit ajout√©!', 'success');
                document.getElementById('newProductName').value = '';
                document.getElementById('newProductCategory').value = '';
                document.getElementById('newProductPrice').value = '';
                toggleAddProduct();
                loadProducts();
            } catch (err) {
                showMessage('productMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        function toggleAddProduct() {
            const section = document.getElementById('addProductSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        async function deleteProduct(productId) {
            if (currentUser.role !== 'admin') {
                alert('Seul un admin peut supprimer un produit');
                return;
            }

            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce produit?')) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('products')
                    .update({ active: false })
                    .eq('id', productId);

                if (error) throw error;

                showMessage('productMessage', '‚úì Produit supprim√©!', 'success');
                loadProducts();
            } catch (err) {
                showMessage('productMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        function openEditProductModal(productId, name, category, price) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'gerant') {
                alert('Vous n\'avez pas les droits');
                return;
            }

            editingProductId = productId;
            document.getElementById('editProductName').value = name;
            document.getElementById('editProductCategory').value = category;
            document.getElementById('editProductPrice').value = price;
            document.getElementById('editProductModal').classList.add('active');
        }

        async function saveProductEdit() {
            if (!editingProductId) return;

            const name = document.getElementById('editProductName').value.trim();
            const category = document.getElementById('editProductCategory').value.trim();
            const price = parseFloat(document.getElementById('editProductPrice').value);

            if (!name || !category || !price || price <= 0) {
                showMessage('editProductMessage', 'Tous les champs sont requis', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('products')
                    .update({
                        name: name,
                        category: category,
                        price: price,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', editingProductId);

                if (error) throw error;

                showMessage('editProductMessage', '‚úì Produit modifi√©!', 'success');
                closeModal('editProductModal');
                editingProductId = null;
                loadProducts();
            } catch (err) {
                showMessage('editProductMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        async function updateSettings() {
            if (currentUser.role !== 'admin') {
                alert('Seul un admin peut modifier les param√®tres');
                return;
            }

            const commissionRate = parseFloat(document.getElementById('commissionRate').value);

            if (!commissionRate || commissionRate < 0) {
                showMessage('settingsMessage', 'Pourcentage invalide', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('settings')
                    .update({ commission_rate: commissionRate })
                    .eq('id', settingsData.id);

                if (error) throw error;

                showMessage('settingsMessage', '‚úì Param√®tres mis √† jour!', 'success');
                loadSettings();
            } catch (err) {
                showMessage('settingsMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        // ============================================
        // PASSWORD / ROLE MANAGEMENT
        // ============================================
        function changeMyPassword() {
            document.getElementById('changePasswordModal').classList.add('active');
            document.getElementById('currentPin').value = '';
            document.getElementById('newPin').value = '';
            document.getElementById('confirmPin').value = '';
        }

        async function saveNewPassword() {
            const currentPin = document.getElementById('currentPin').value;
            const newPin = document.getElementById('newPin').value;
            const confirmPin = document.getElementById('confirmPin').value;

            if (!currentPin || !newPin || !confirmPin) {
                showMessage('passwordMessage', 'Tous les champs sont requis', 'error');
                return;
            }

            if (currentPin !== currentUser.pin_code) {
                showMessage('passwordMessage', 'PIN actuel incorrect', 'error');
                return;
            }

            if (newPin !== confirmPin) {
                showMessage('passwordMessage', 'Les nouveaux PINs ne correspondent pas', 'error');
                return;
            }

            if (newPin.length !== 4) {
                showMessage('passwordMessage', 'Le PIN doit contenir 4 chiffres', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('collaborators')
                    .update({ pin_code: newPin })
                    .eq('id', currentUser.id);

                if (error) throw error;

                currentUser.pin_code = newPin;
                showMessage('passwordMessage', '‚úì PIN mis √† jour!', 'success');
                setTimeout(() => {
                    closeModal('changePasswordModal');
                }, 1500);
            } catch (err) {
                showMessage('passwordMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        function openChangeRoleModal(userId, userName, currentRole) {
            document.getElementById('changeRoleUserName').textContent = 'Utilisateur: ' + userName + ' (R√¥le actuel: ' + currentRole + ')';
            document.getElementById('changeRoleSelect').value = currentRole;
            document.getElementById('changeUserRoleModal').dataset.userId = userId;
            document.getElementById('changeUserRoleModal').classList.add('active');
        }

        async function saveUserRole() {
            if (currentUser.role !== 'admin') {
                alert('Seul un admin peut changer les r√¥les');
                return;
            }

            const userId = document.getElementById('changeUserRoleModal').dataset.userId;
            const newRole = document.getElementById('changeRoleSelect').value;

            try {
                const { error } = await supabaseClient
                    .from('collaborators')
                    .update({ role: newRole, updated_by: currentUser.name })
                    .eq('id', userId);

                if (error) throw error;

                showMessage('collaboratorMessage', '‚úì R√¥le mis √† jour!', 'success');
                closeModal('changeUserRoleModal');
                loadCollaborators();
            } catch (err) {
                showMessage('collaboratorMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        async function deleteCollaborator(userId, userName) {
            if (currentUser.role !== 'admin') {
                alert('Seul un admin peut supprimer un utilisateur');
                return;
            }

            const user = collaboratorsData.find(c => c.id === userId);
            const action = user.is_active ? 'd√©sactiver' : 'r√©activer';

            if (!confirm(`√ätes-vous s√ªr de vouloir ${action} ${userName}?`)) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('collaborators')
                    .update({ is_active: !user.is_active, updated_by: currentUser.name })
                    .eq('id', userId);

                if (error) throw error;

                showMessage('collaboratorMessage', `‚úì Utilisateur ${action}!`, 'success');
                loadCollaborators();
            } catch (err) {
                showMessage('collaboratorMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        // ============================================
        // EXPENSES MANAGEMENT
        // ============================================
        async function submitExpense() {
            const type = document.getElementById('expenseType').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const description = document.getElementById('expenseDescription').value;

            if (!type || !amount || amount <= 0) {
                showMessage('expenseMessage', 'Tous les champs sont requis', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('expense_requests')
                    .insert([{
                        employee_id: currentUser.id,
                        employee_name: currentUser.name,
                        expense_type: type,
                        amount: amount,
                        description: description,
                        status: 'pending',
                        created_at: new Date().toISOString()
                    }]);

                if (error) throw error;

                showMessage('expenseMessage', '‚úì Demande soumise!', 'success');
                document.getElementById('expenseType').value = '';
                document.getElementById('expenseAmount').value = '';
                document.getElementById('expenseDescription').value = '';
                loadExpenses();
            } catch (err) {
                showMessage('expenseMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        async function approveExpense(expenseId, amount) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'gerant') {
                alert('Vous n\'avez pas les droits');
                return;
            }

            if (!confirm(`Rembourser ${amount.toFixed(2)}‚Ç¨? Cela d√©duira du solde de caisse.`)) {
                return;
            }

            try {
                const { error: updateError } = await supabaseClient
                    .from('expense_requests')
                    .update({ status: 'approved' })
                    .eq('id', expenseId);

                if (updateError) throw updateError;

                let currentBalance = 0;
                if (movementsData.length > 0) {
                    currentBalance = parseFloat(movementsData[0].balance_after) || 0;
                }
                const newBalance = currentBalance - amount;

                const { error: movementError } = await supabaseClient
                    .from('movements')
                    .insert([{
                        type: 'retrait',
                        description: `Remboursement de frais`,
                        amount: amount,
                        balance_after: newBalance
                    }]);

                if (movementError) throw movementError;

                showMessage('expenseMessage', '‚úì Remboursement effectu√©!', 'success');
                loadExpenses();
                loadMovements();
            } catch (err) {
                showMessage('expenseMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        async function rejectExpense(expenseId) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'gerant') {
                alert('Vous n\'avez pas les droits');
                return;
            }

            if (!confirm('√ätes-vous s√ªr de vouloir refuser cette demande?')) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('expense_requests')
                    .delete()
                    .eq('id', expenseId);

                if (error) throw error;

                showMessage('expenseMessage', '‚úì Demande refus√©e!', 'success');
                loadExpenses();
            } catch (err) {
                showMessage('expenseMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        async function correctCashBalance() {
            if (currentUser.role !== 'admin') {
                alert('Seul un admin peut corriger le solde');
                return;
            }

            const newBalance = parseFloat(document.getElementById('newCashBalance').value);
            const reason = document.getElementById('cashCorrectionReason').value;

            if (!newBalance || !reason) {
                showMessage('cashCorrectionMessage', 'Tous les champs sont requis', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('movements')
                    .insert([{
                        type: 'correction',
                        description: `Correction du solde: ${reason}`,
                        amount: 0,
                        balance_after: newBalance
                    }]);

                if (error) throw error;

                showMessage('cashCorrectionMessage', '‚úì Solde corrig√©!', 'success');
                document.getElementById('newCashBalance').value = '';
                document.getElementById('cashCorrectionReason').value = '';
                loadMovements();
            } catch (err) {
                showMessage('cashCorrectionMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        // ============================================
        // ADMIN FUNCTIONS
        // ============================================
        function exportData() {
            const exportData = {
                collaborators: collaboratorsData,
                sales: salesData,
                movements: movementsData,
                products: productsData,
                expenses: expensesData,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `palace-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è ATTENTION! Cette action supprimera TOUTES les donn√©es. √ätes-vous absolument s√ªr?')) {
                return;
            }

            if (!confirm('‚ö†Ô∏è DERNI√àRE CONFIRMATION - Cette action ne peut pas √™tre annul√©e!')) {
                return;
            }

            try {
                await supabaseClient.from('sales').delete().gt('id', 0);
                await supabaseClient.from('movements').delete().gt('id', 0);

                loadAllData();
                showMessage('settingsMessage', '‚úì Donn√©es supprim√©es!', 'success');
            } catch (err) {
                showMessage('settingsMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        // ============================================
        // REALTIME SUBSCRIPTIONS
        // ============================================
        function setupRealtimeSubscriptions() {
            supabaseClient
                .channel('sales-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sales' }, () => {
                    loadSales();
                })
                .subscribe();

            supabaseClient
                .channel('movements-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'movements' }, () => {
                    loadMovements();
                })
                .subscribe();

            supabaseClient
                .channel('collaborators-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'collaborators' }, () => {
                    loadCollaborators();
                })
                .subscribe();

            supabaseClient
                .channel('products-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, () => {
                    loadProducts();
                })
                .subscribe();

            supabaseClient
                .channel('expenses-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'expense_requests' }, () => {
                    loadExpenses();
                })
                .subscribe();
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('load', () => {
            initSupabase();
        });
    </script>
</body>
</html>
