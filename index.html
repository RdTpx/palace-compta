<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LE PALACE - Comptabilit√©</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 1000px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .login-section {
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        input {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .main-app {
            display: none;
            padding: 30px;
        }

        .main-app.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab-button {
            padding: 12px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: #f0f0f0;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .success {
            color: #10b981;
            font-weight: 600;
        }

        .error {
            color: #ef4444;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f0f0f0;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .user-info span {
            font-weight: 600;
            color: #333;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h4 {
            opacity: 0.9;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .stat-card p {
            font-size: 2em;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .action-buttons button {
            padding: 10px 20px;
            font-size: 0.9em;
        }

        .message {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.admin {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge.manager {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.employee {
            background: #dbeafe;
            color: #1e40af;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- LOGIN SECTION -->
        <div id="loginSection" class="active">
            <div class="header">
                <h1>üëë LE PALACE</h1>
                <p>Syst√®me de Comptabilit√© pour Bars & Restaurants</p>
            </div>

            <div class="login-section">
                <div class="form-group">
                    <label for="username">Pseudo</label>
                    <input type="text" id="username" placeholder="Entrez votre pseudo">
                </div>

                <div class="form-group">
                    <label for="pin">PIN (4 chiffres)</label>
                    <input type="password" id="pin" placeholder="Entrez votre PIN" maxlength="4" inputmode="numeric">
                </div>

                <button class="btn-primary" onclick="login()">Connexion</button>

                <div id="loginError" style="display: none; color: #ef4444; text-align: center; padding: 10px; background: #fee2e2; border-radius: 6px;"></div>
            </div>
        </div>

        <!-- MAIN APP SECTION -->
        <div id="mainApp" class="main-app">
            <div class="header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1>üëë LE PALACE</h1>
                        <p>Bienvenue!</p>
                    </div>
                    <div>
                        <span id="userDisplay" style="margin-right: 15px;"></span>
                        <button class="logout-btn" onclick="logout()">D√©connexion</button>
                    </div>
                </div>
            </div>

            <div style="padding: 30px;">
                <!-- USER INFO -->
                <div class="user-info">
                    <div>
                        <span>Utilisateur: </span>
                        <span id="userName" style="color: #667eea;"></span>
                    </div>
                    <div>
                        <span id="userRole" class="badge"></span>
                    </div>
                </div>

                <!-- STATS -->
                <div class="stats">
                    <div class="stat-card">
                        <h4>üí∞ Total Ventes (Aujourd'hui)</h4>
                        <p id="totalSalesToday">0.00 ‚Ç¨</p>
                    </div>
                    <div class="stat-card">
                        <h4>üë• Collaborateurs</h4>
                        <p id="totalCollaborators">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>üìä Commission (30%)</h4>
                        <p id="totalCommission">0.00 ‚Ç¨</p>
                    </div>
                    <div class="stat-card">
                        <h4>üíµ Solde Caisse</h4>
                        <p id="cashBalance">0.00 ‚Ç¨</p>
                    </div>
                </div>

                <!-- TABS -->
                <div class="tabs">
                    <button class="tab-button active" onclick="switchTab('sales')">üìä Ventes</button>
                    <button class="tab-button" onclick="switchTab('movements')">üí∏ Mouvements</button>
                    <button class="tab-button" onclick="switchTab('collaborators')">üë• Collaborateurs</button>
                    <button class="tab-button" onclick="switchTab('settings')">‚öôÔ∏è Param√®tres</button>
                </div>

                <!-- TAB 1: SALES -->
                <div id="sales" class="tab-content active">
                    <div class="form-section">
                        <h3>Enregistrer une Vente</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="collaboratorSelect">Collaborateur</label>
                                <select id="collaboratorSelect">
                                    <option value="">-- S√©lectionner --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="saleAmount">Montant (‚Ç¨)</label>
                                <input type="number" id="saleAmount" placeholder="0.00" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="paymentMode">Mode de Paiement</label>
                                <select id="paymentMode">
                                    <option value="liquide">Liquide</option>
                                    <option value="carte">Carte</option>
                                    <option value="cheque">Ch√®que</option>
                                    <option value="virement">Virement</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn-primary" onclick="recordSale()">‚úì Enregistrer la Vente</button>
                        <div id="saleMessage"></div>
                    </div>

                    <div class="table-container">
                        <h3>Historique des Ventes</h3>
                        <table id="salesTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Collaborateur</th>
                                    <th>Montant</th>
                                    <th>Mode de Paiement</th>
                                </tr>
                            </thead>
                            <tbody id="salesBody">
                                <tr><td colspan="4" class="loading">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB 2: MOVEMENTS -->
                <div id="movements" class="tab-content">
                    <div class="form-section">
                        <h3>Ajouter un Mouvement</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="movementType">Type de Mouvement</label>
                                <select id="movementType">
                                    <option value="depot">D√©p√¥t</option>
                                    <option value="retrait">Retrait</option>
                                    <option value="depense">D√©pense</option>
                                    <option value="commission">Commission Pay√©e</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="movementAmount">Montant (‚Ç¨)</label>
                                <input type="number" id="movementAmount" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="movementDescription">Description</label>
                            <textarea id="movementDescription" placeholder="D√©tails du mouvement..." rows="3"></textarea>
                        </div>
                        <button class="btn-primary" onclick="recordMovement()">‚úì Enregistrer</button>
                        <div id="movementMessage"></div>
                    </div>

                    <div class="table-container">
                        <h3>Historique des Mouvements</h3>
                        <table id="movementsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Montant</th>
                                    <th>Solde Apr√®s</th>
                                </tr>
                            </thead>
                            <tbody id="movementsBody">
                                <tr><td colspan="5" class="loading">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB 3: COLLABORATORS -->
                <div id="collaborators" class="tab-content">
                    <div class="form-section" id="addCollaboratorSection" style="display: none;">
                        <h3>Ajouter un Collaborateur</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newCollaboratorName">Nom</label>
                                <input type="text" id="newCollaboratorName" placeholder="Jean Dupont">
                            </div>
                            <div class="form-group">
                                <label for="newCollaboratorRole">R√¥le</label>
                                <select id="newCollaboratorRole">
                                    <option value="employe">Employ√©</option>
                                    <option value="gerant">G√©rant</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newCollaboratorPin">PIN</label>
                                <input type="text" id="newCollaboratorPin" placeholder="1234" maxlength="4" inputmode="numeric">
                            </div>
                        </div>
                        <button class="btn-primary" onclick="addCollaborator()">‚úì Ajouter</button>
                        <div id="collaboratorMessage"></div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-primary" id="addCollaboratorBtn" onclick="toggleAddCollaborator()" style="display: none;">+ Ajouter Collaborateur</button>
                    </div>

                    <div class="table-container">
                        <h3>Collaborateurs</h3>
                        <table id="collaboratorsTable">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>R√¥le</th>
                                    <th>PIN</th>
                                    <th>Cr√©√© le</th>
                                </tr>
                            </thead>
                            <tbody id="collaboratorsBody">
                                <tr><td colspan="4" class="loading">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB 4: SETTINGS -->
                <div id="settings" class="tab-content">
                    <div class="form-section" id="settingsSection" style="display: none;">
                        <h3>Param√®tres G√©n√©raux</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="commissionRate">Taux de Commission (%)</label>
                                <input type="number" id="commissionRate" placeholder="30" step="0.01">
                            </div>
                        </div>
                        <button class="btn-primary" onclick="updateSettings()">‚úì Mettre √† Jour</button>
                        <div id="settingsMessage"></div>
                    </div>

                    <div class="action-buttons" style="display: none;" id="adminPanel">
                        <button class="btn-secondary" onclick="exportData()">üì• Exporter les Donn√©es</button>
                        <button class="btn-secondary" onclick="clearAllData()" style="background: #fee2e2; color: #991b1b;">üóëÔ∏è R√©initialiser (Attention!)</button>
                    </div>

                    <div style="background: #f0f0f0; padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <h3>√Ä Propos</h3>
                        <p>LE PALACE v1.0 - Comptabilit√© Cloud</p>
                        <p style="margin-top: 10px; color: #666; font-size: 0.95em;">Application h√©berg√©e sur Vercel + Base de donn√©es Supabase PostgreSQL</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION SUPABASE (UNE SEULE FOIS)
        // ============================================
        const SUPABASE_URL = 'https://wjhbnyrjyjaezaktueny.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqaGJueXJqeWphZXpha3R1ZW55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNTI4NjQsImV4cCI6MjA4NDkyODg2NH0.c0MAaZdNyj_l0ccso78YO2Ca39Me-MSbvauo5Hjkxuc';

        let supabase = null;

// Clear window supabase to avoid conflicts
if (window.supabase) delete window.supabase;

function initSupabase() {
    // Make sure supabase client is loaded from CDN
    const maxAttempts = 50;
    let attempts = 0;
    
    const waitForSupabase = setInterval(() => {
        if (window.supabase && window.supabase.createClient) {
            clearInterval(waitForSupabase);
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                
                // Check if Supabase keys are set
                if (SUPABASE_URL.includes('YOUR_PROJECT')) {
                    alert('‚ùå Erreur: Configurez d\'abord vos cl√©s Supabase!\n\nRemplissez SUPABASE_URL et SUPABASE_ANON_KEY dans le code.');
                }
            } else {
                alert('‚ùå Erreur: La librairie Supabase n\'a pas pu √™tre charg√©e!\n\nV√©rifiez votre connexion Internet.');
            }
        }

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let currentUser = null;
        let currentTab = 'sales';
        let salesData = [];
        let movementsData = [];
        let collaboratorsData = [];
        let settingsData = null;

        // ============================================
        // LOGIN / LOGOUT
        // ============================================
        async function login() {
            const username = document.getElementById('username').value.trim();
            const pin = document.getElementById('pin').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!username || !pin) {
                errorDiv.textContent = 'Veuillez remplir tous les champs';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('collaborators')
                    .select('*')
                    .eq('name', username)
                    .eq('pin_code', pin)
                    .single();

                if (error || !data) {
                    errorDiv.textContent = 'Identifiants incorrects';
                    errorDiv.style.display = 'block';
                    return;
                }

                currentUser = data;
                errorDiv.style.display = 'none';

                // Switch to main app
                document.getElementById('loginSection').classList.remove('active');
                document.getElementById('mainApp').classList.add('active');

                // Update UI
                updateUserDisplay();
                loadAllData();
                setupRealtimeSubscriptions();
            } catch (err) {
                errorDiv.textContent = 'Erreur: ' + err.message;
                errorDiv.style.display = 'block';
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('loginSection').classList.add('active');
            document.getElementById('username').value = '';
            document.getElementById('pin').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // ============================================
        // UI UPDATES
        // ============================================
        function updateUserDisplay() {
            const roleMap = {
                'admin': 'Admin üëë',
                'gerant': 'G√©rant üìã',
                'employe': 'Employ√© üíº'
            };

            document.getElementById('userName').textContent = currentUser.name;
            const userRole = document.getElementById('userRole');
            userRole.textContent = roleMap[currentUser.role] || currentUser.role;
            userRole.className = `badge ${currentUser.role}`;

            // Show admin features
            if (currentUser.role === 'admin' || currentUser.role === 'gerant') {
                document.getElementById('addCollaboratorBtn').style.display = 'block';
                document.getElementById('settingsSection').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'flex';
            }

            document.getElementById('userDisplay').textContent = currentUser.name;
        }

        function switchTab(tabName) {
            currentTab = tabName;

            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');

            // Highlight button
            event.target.classList.add('active');
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';

            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadAllData() {
            await Promise.all([
                loadCollaborators(),
                loadSales(),
                loadMovements(),
                loadSettings()
            ]);
        }

        async function loadCollaborators() {
            const { data, error } = await supabase
                .from('collaborators')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading collaborators:', error);
                return;
            }

            collaboratorsData = data || [];

            // Update select dropdown
            const select = document.getElementById('collaboratorSelect');
            select.innerHTML = '<option value="">-- S√©lectionner --</option>';
            collaboratorsData.forEach(collab => {
                const option = document.createElement('option');
                option.value = collab.id;
                option.textContent = collab.name;
                select.appendChild(option);
            });

            // Update collaborators table
            const tbody = document.getElementById('collaboratorsBody');
            if (collaboratorsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Aucun collaborateur</td></tr>';
            } else {
                tbody.innerHTML = collaboratorsData.map(collab => `
                    <tr>
                        <td><strong>${collab.name}</strong></td>
                        <td><span class="badge ${collab.role}">${collab.role}</span></td>
                        <td>${collab.pin_code}</td>
                        <td>${new Date(collab.created_at).toLocaleDateString('fr-FR')}</td>
                    </tr>
                `).join('');
            }

            document.getElementById('totalCollaborators').textContent = collaboratorsData.length;
        }

        async function loadSales() {
            const { data, error } = await supabase
                .from('sales')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading sales:', error);
                return;
            }

            salesData = data || [];

            // Update sales table
            const tbody = document.getElementById('salesBody');
            if (salesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Aucune vente enregistr√©e</td></tr>';
            } else {
                tbody.innerHTML = salesData.map(sale => `
                    <tr>
                        <td>${new Date(sale.created_at).toLocaleString('fr-FR')}</td>
                        <td>${sale.collaborator_name}</td>
                        <td class="success">${sale.amount.toFixed(2)} ‚Ç¨</td>
                        <td>${sale.payment_mode}</td>
                    </tr>
                `).join('');
            }

            updateStats();
        }

        async function loadMovements() {
            const { data, error } = await supabase
                .from('movements')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading movements:', error);
                return;
            }

            movementsData = data || [];

            // Update movements table
            const tbody = document.getElementById('movementsBody');
            if (movementsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">Aucun mouvement</td></tr>';
            } else {
                tbody.innerHTML = movementsData.map(mov => `
                    <tr>
                        <td>${new Date(mov.created_at).toLocaleString('fr-FR')}</td>
                        <td><strong>${mov.type}</strong></td>
                        <td>${mov.description || '-'}</td>
                        <td class="success">${mov.amount.toFixed(2)} ‚Ç¨</td>
                        <td class="success">${mov.balance_after.toFixed(2)} ‚Ç¨</td>
                    </tr>
                `).join('');
            }

            updateStats();
        }

        async function loadSettings() {
            const { data, error } = await supabase
                .from('settings')
                .select('*')
                .single();

            if (error) {
                console.error('Error loading settings:', error);
                return;
            }

            settingsData = data;
            document.getElementById('commissionRate').value = settingsData.commission_rate || 30;
        }

        // ============================================
        // STATISTICS
        // ============================================
        function updateStats() {
            // Total sales today
            const today = new Date().toDateString();
            const todaySales = salesData.filter(sale => {
                const saleDate = new Date(sale.created_at).toDateString();
                return saleDate === today;
            });
            const totalToday = todaySales.reduce((sum, sale) => sum + parseFloat(sale.amount), 0);
            document.getElementById('totalSalesToday').textContent = totalToday.toFixed(2) + ' ‚Ç¨';

            // Commission
            const commissionRate = settingsData?.commission_rate || 30;
            const totalCommission = (totalToday * commissionRate) / 100;
            document.getElementById('totalCommission').textContent = totalCommission.toFixed(2) + ' ‚Ç¨';

            // Cash balance
            let cashBalance = 0;
            movementsData.forEach(mov => {
                if (mov.balance_after) {
                    cashBalance = parseFloat(mov.balance_after);
                }
            });
            document.getElementById('cashBalance').textContent = cashBalance.toFixed(2) + ' ‚Ç¨';
        }

        // ============================================
        // RECORD OPERATIONS
        // ============================================
        async function recordSale() {
            const collaboratorId = document.getElementById('collaboratorSelect').value;
            const amount = parseFloat(document.getElementById('saleAmount').value);
            const paymentMode = document.getElementById('paymentMode').value;

            if (!collaboratorId || !amount || amount <= 0) {
                showMessage('saleMessage', 'Veuillez remplir tous les champs', 'error');
                return;
            }

            try {
                const collaborator = collaboratorsData.find(c => c.id == collaboratorId);

                const { error } = await supabase
                    .from('sales')
                    .insert([{
                        collaborator_id: collaboratorId,
                        collaborator_name: collaborator.name,
                        amount: amount,
                        payment_mode: paymentMode
                    }]);

                if (error) throw error;

                showMessage('saleMessage', '‚úì Vente enregistr√©e avec succ√®s!', 'success');
                document.getElementById('collaboratorSelect').value = '';
                document.getElementById('saleAmount').value = '';
                loadSales();
            } catch (err) {
                showMessage('saleMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        async function recordMovement() {
            const type = document.getElementById('movementType').value;
            const amount = parseFloat(document.getElementById('movementAmount').value);
            const description = document.getElementById('movementDescription').value;

            if (!amount || amount <= 0) {
                showMessage('movementMessage', 'Veuillez entrer un montant valide', 'error');
                return;
            }

            try {
                // Calculate new balance
                let currentBalance = 0;
                if (movementsData.length > 0) {
                    currentBalance = parseFloat(movementsData[0].balance_after) || 0;
                }

                let newBalance = currentBalance;
                if (type === 'depot' || type === 'commission') {
                    newBalance += amount;
                } else {
                    newBalance -= amount;
                }

                const { error } = await supabase
                    .from('movements')
                    .insert([{
                        type: type,
                        description: description,
                        amount: amount,
                        balance_after: newBalance
                    }]);

                if (error) throw error;

                showMessage('movementMessage', '‚úì Mouvement enregistr√©!', 'success');
                document.getElementById('movementAmount').value = '';
                document.getElementById('movementDescription').value = '';
                loadMovements();
            } catch (err) {
                showMessage('movementMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        async function addCollaborator() {
            const name = document.getElementById('newCollaboratorName').value.trim();
            const role = document.getElementById('newCollaboratorRole').value;
            const pin = document.getElementById('newCollaboratorPin').value.trim();

            if (!name || !pin || pin.length < 4) {
                showMessage('collaboratorMessage', 'Veuillez remplir tous les champs correctement', 'error');
                return;
            }

            try {
                const { error } = await supabase
                    .from('collaborators')
                    .insert([{
                        name: name,
                        role: role,
                        pin_code: pin
                    }]);

                if (error) throw error;

                showMessage('collaboratorMessage', '‚úì Collaborateur ajout√©!', 'success');
                document.getElementById('newCollaboratorName').value = '';
                document.getElementById('newCollaboratorPin').value = '';
                toggleAddCollaborator();
                loadCollaborators();
            } catch (err) {
                showMessage('collaboratorMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        function toggleAddCollaborator() {
            const section = document.getElementById('addCollaboratorSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        async function updateSettings() {
            const commissionRate = parseFloat(document.getElementById('commissionRate').value);

            if (!commissionRate || commissionRate < 0) {
                showMessage('settingsMessage', 'Veuillez entrer un pourcentage valide', 'error');
                return;
            }

            try {
                const { error } = await supabase
                    .from('settings')
                    .update({ commission_rate: commissionRate })
                    .eq('id', settingsData.id);

                if (error) throw error;

                showMessage('settingsMessage', '‚úì Param√®tres mis √† jour!', 'success');
                loadSettings();
            } catch (err) {
                showMessage('settingsMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        // ============================================
        // ADMIN FUNCTIONS
        // ============================================
        function exportData() {
            const exportData = {
                collaborators: collaboratorsData,
                sales: salesData,
                movements: movementsData,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `palace-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è √ätes-vous absolument s√ªr? Cette action ne peut pas √™tre annul√©e!')) {
                return;
            }

            try {
                await supabase.from('sales').delete().gt('id', 0);
                await supabase.from('movements').delete().gt('id', 0);

                loadAllData();
                showMessage('settingsMessage', '‚úì Donn√©es supprim√©es!', 'success');
            } catch (err) {
                showMessage('settingsMessage', 'Erreur: ' + err.message, 'error');
            }
        }

        // ============================================
        // REALTIME SUBSCRIPTIONS
        // ============================================
        function setupRealtimeSubscriptions() {
            // Subscribe to sales changes
            supabase
                .channel('sales-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'sales' }, () => {
                    loadSales();
                })
                .subscribe();

            // Subscribe to movements changes
            supabase
                .channel('movements-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'movements' }, () => {
                    loadMovements();
                })
                .subscribe();

            // Subscribe to collaborators changes
            supabase
                .channel('collaborators-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'collaborators' }, () => {
                    loadCollaborators();
                })
                .subscribe();
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('load', () => {
            initSupabase();
        });
    </script>
</body>
</html>
